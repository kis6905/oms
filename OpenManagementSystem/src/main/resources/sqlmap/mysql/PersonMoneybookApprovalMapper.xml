<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.open.ms.service.mapper.PersonMoneybookApprovalMapper">

	<resultMap id="totalMap" type="Map">
        <result javaType="Integer" column="totalCnt" property="totalCnt"/>
        <result javaType="Integer" column="totalPrice" property="totalPrice"/>
	</resultMap> 
    
    <select id="getPersonMoneybookApprovalList" parameterType="Map" resultType="com.open.ms.service.vo.PersonMoneybookApproval">
    	SELECT
			`no`,
		    seq,
			usedDate,
			summary,
			usedPlace,
			price,
			note,
			memberId,
			registeredDate,
			modifiedDate
		FROM ( SELECT
				  @ROWNUM := @ROWNUM + 1 AS `no`,
				  seq,
				  usedDate,
				  summary,
				  usedPlace,
				  price,
				  note,
				  memberId,
				  registeredDate,
				  modifiedDate
			   FROM ( SELECT @ROWNUM := 0 AS `no`) R,
				    ( SELECT
					     seq,
					     usedDate,
					     summary,
					     usedPlace,
					     price,
					     note,
					     memberId,
					     DATE_FORMAT(registeredDate, '%Y-%m-%d %H:%i:%s') AS registeredDate,
					     DATE_FORMAT(modifiedDate, '%Y-%m-%d %H:%i:%s') AS modifiedDate
				      FROM oms_person_moneybook_approval
				      WHERE memberId = #{memberId}
					    AND usedDate BETWEEN #{startDate} AND #{endDate}
				      ORDER BY ${sort} ${order}
					) T
			  ) T1
		WHERE `no` BETWEEN #{start} AND #{end}
    </select>
    
    <select id="getPersonMoneybookApprovalListTotalCnt" parameterType="Map" resultMap="totalMap">
    	SELECT
    		COUNT(seq) AS totalCnt
		FROM oms_person_moneybook_approval
		WHERE memberId = #{memberId}
		  AND usedDate BETWEEN #{startDate} AND #{endDate}
    </select>
    
    <insert id="insertPersonMoneybookApproval" parameterType="com.open.ms.service.vo.PersonMoneybookApproval">
		INSERT INTO `oms_person_moneybook_approval` (
			`seq`,
			`sentMemberId`,
			`receivedMemberId`,
			`title`,
			`sentMemberSign`,
			`receivedMemberSign`,
			`statusCodeGroup`,
		    `statusCode`,
			`startDate`,
			`endDate`,
			`completedDate`,
			`registeredDate`
		)
		VALUES (
			IF((SELECT MAX(seq) FROM oms_person_moneybook_approval t) IS NULL, 0, (SELECT MAX(seq) + 1 FROM oms_person_moneybook_approval t1) ), 
			#{sentMemberId},
			#{receivedMemberId},
			#{title},
			#{sentMemberSign},
			#{receivedMemberSign},
			#{statusCodeGroup},
		    #{statusCode},
			#{startDate},
			#{endDate},
			#{completedDate},
			SYSDATE()
		)
    </insert>

	<update id="updatePersonMoneybookApproval" parameterType="com.open.ms.service.vo.PersonMoneybookApproval">
		UPDATE `oms_person_moneybook_approval`
		SET usedDate = #{usedDate},
			summary = #{summary},
			price = #{price},
			note = #{note},
			modifiedDate = SYSDATE()
		WHERE seq = #{seq}
		  AND memberId = #{memberId}
	</update>
	
	<delete id="deletePersonMoneybookApproval" parameterType="com.open.ms.service.vo.PersonMoneybookApproval">
		DELETE FROM `oms_person_moneybook_approval`
		WHERE seq = #{seq}
		  AND memberId = #{memberId}
	</delete>
	
</mapper>
